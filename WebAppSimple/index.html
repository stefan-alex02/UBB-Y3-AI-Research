<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Image Prediction</title>
  <style>
    /* ... (CSS styles remain the same) ... */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f5f7;
      color: #172B4D;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #0052CC;
      text-align: center;
      margin-bottom: 30px;
    }
    .upload-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px dashed #dfe1e6;
      border-radius: 6px;
      text-align: center;
    }
    .upload-section input[type="file"] {
      display: none;
    }
    .upload-section label.file-label {
      display: inline-block;
      padding: 12px 20px;
      background-color: #0065FF;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .upload-section label.file-label:hover {
      background-color: #0052CC;
    }
    .upload-section button {
      padding: 12px 20px;
      background-color: #36B37E;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      transition: background-color 0.2s;
    }
    .upload-section button:hover {
      background-color: #00875A;
    }
    .upload-section button:disabled {
      background-color: #c1c7d0;
      cursor: not-allowed;
    }
    .options {
      margin-top: 15px;
      text-align: center;
    }
    .options label {
      margin-right: 15px;
    }
    .status {
      margin-top: 15px;
      text-align: center;
      font-style: italic;
      color: #505F79;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .result-card {
      background-color: #f9f9f9;
      border: 1px solid #dfe1e6;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .result-card img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 4px;
      margin-bottom: 10px;
      object-fit: contain;
      border: 1px solid #ccc;
    }
    .result-card .placeholder {
      width: 100%;
      height: 150px;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 0.9em;
      border-radius: 4px;
      margin-bottom: 10px;
      text-align: center;
    }
    .result-card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.1em;
      color: #172B4D;
    }
    .result-card p {
      margin: 4px 0;
      font-size: 0.9em;
      color: #42526E;
    }
    .result-card .top-k {
      font-size: 0.8em;
      margin-top: 8px;
      width: 100%;
    }
    .result-card .top-k li {
      list-style-type: none;
      padding-left: 0;
    }
    .result-card .lime-image-container {
      margin-top: 10px;
      width: 100%;
    }
    .result-card .lime-image-container h4 {
      font-size: 0.9em;
      margin-bottom: 5px;
      color: #0052CC;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Cloud Image Classification & Explainability</h1>

  <div class="upload-section">
    <input type="file" id="imageUpload" multiple accept="image/png, image/jpeg, image/jpg">
    <label for="imageUpload" class.file-label">Select Images</label>
    <div class="options">
      <label for="generateLIME">
        <input type="checkbox" id="generateLIME"> Generate LIME Explanations
      </label>
    </div>
    <button id="predictButton" disabled>Predict</button>
    <p id="fileInfo">No files selected.</p>
  </div>

  <div id="status" class="status"></div>
  <div id="resultsGrid" class.results-grid"></div>
</div>

<script>
  const imageUpload = document.getElementById('imageUpload');
  const predictButton = document.getElementById('predictButton');
  const resultsGrid = document.getElementById('resultsGrid');
  const statusDiv = document.getElementById('status');
  const fileInfo = document.getElementById('fileInfo');
  const generateLIMECheckbox = document.getElementById('generateLIME');

  // Store selected files globally within this script's scope
  let currentSelectedFiles = [];

  imageUpload.addEventListener('change', (event) => {
    currentSelectedFiles = Array.from(event.target.files); // Update the global list
    updateButtonAndFileInfo();
  });

  function updateButtonAndFileInfo() {
    if (currentSelectedFiles.length > 0) {
      predictButton.disabled = false;
      fileInfo.textContent = `${currentSelectedFiles.length} image(s) selected.`;
    } else {
      predictButton.disabled = true;
      fileInfo.textContent = 'No files selected.';
    }
  }

  predictButton.addEventListener('click', async () => {
    if (currentSelectedFiles.length === 0) {
      alert('Please select images first.');
      return;
    }

    statusDiv.textContent = 'Processing... Please wait.';
    predictButton.disabled = true; // Disable during processing
    resultsGrid.innerHTML = '';

    const formData = new FormData();
    currentSelectedFiles.forEach(file => {
      formData.append('images', file);
    });

    let endpointUrl = 'http://127.0.0.1:5001/predict';
    const queryParams = [];
    if (generateLIMECheckbox.checked) {
      queryParams.push('lime=true');
      // Add other LIME params like features/samples if you make them configurable in UI
      // queryParams.push('lime_features=5');
      // queryParams.push('lime_samples=100');
    }
    if (queryParams.length > 0) {
      endpointUrl += '?' + queryParams.join('&');
    }

    try {
      const response = await fetch(endpointUrl, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: `Server error ${response.status}` }));
        throw new Error(`HTTP error ${response.status}: ${errorData.error || response.statusText}`);
      }

      const data = await response.json();

      if (data.predictions && data.predictions.length > 0) {
        // Pass currentSelectedFiles to displayResults for previewing originals
        displayResults(data.predictions, currentSelectedFiles);
        statusDiv.textContent = `Processed ${data.predictions.length} images.`;
      } else if (data.error) {
        statusDiv.textContent = `Error: ${data.error}`;
      } else {
        statusDiv.textContent = 'No predictions returned or an unknown issue occurred.';
      }
    } catch (error) {
      statusDiv.textContent = `Error: ${error.message}`;
      console.error('Prediction error:', error);
    } finally {
      // Re-enable button based on whether files are still "selected" (input field retains them)
      // Or, to force re-selection after prediction, clear currentSelectedFiles and update:
      // currentSelectedFiles = [];
      // imageUpload.value = null; // Clear the file input
      updateButtonAndFileInfo(); // Update based on currentSelectedFiles
    }
  });

  function displayResults(predictions, originalFiles) {
    predictions.forEach((pred) => {
      const card = document.createElement('div');
      card.className = 'result-card';

      const identifier = pred.identifier || pred.image_path || `pred_${resultsGrid.children.length}`;

      // Attempt to find the original uploaded file by its identifier (name) for preview
      const originalFile = originalFiles.find(f => f.name === identifier);

      if (originalFile) {
        const imgElement = document.createElement('img');
        const reader = new FileReader();
        reader.onload = (e) => { imgElement.src = e.target.result; }
        reader.readAsDataURL(originalFile);
        imgElement.alt = `Original: ${identifier}`;
        card.appendChild(imgElement);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        placeholder.textContent = `Original Image:\n${identifier}\n(Preview N/A)`;
        card.appendChild(placeholder);
      }
      // ... (rest of the card content: title, confidence, top-k - unchanged)
      const title = document.createElement('h3');
      title.textContent = `Predicted: ${pred.predicted_class_name}`;
      card.appendChild(title);

      const confidence = document.createElement('p');
      confidence.textContent = `Confidence: ${pred.confidence.toFixed(3)}`;
      card.appendChild(confidence);

      if (pred.top_k_predictions && pred.top_k_predictions.length > 0) {
        const topKList = document.createElement('ul');
        topKList.className = 'top-k';
        topKList.innerHTML = '<strong>Top Predictions:</strong>';
        pred.top_k_predictions.forEach(p => {
          const listItem = document.createElement('li');
          listItem.textContent = `${p[0]}: ${p[1].toFixed(3)}`;
          topKList.appendChild(listItem);
        });
        card.appendChild(topKList);
      }


      if (pred.lime_explanation && pred.lime_explanation.lime_image_base64) {
        const limeContainer = document.createElement('div');
        limeContainer.className = 'lime-image-container';
        const limeTitle = document.createElement('h4');
        limeTitle.textContent = `LIME Explanation (for ${pred.lime_explanation.explained_class_name || pred.predicted_class_name}):`;
        limeContainer.appendChild(limeTitle);

        const limeImgElement = document.createElement('img');
        limeImgElement.src = 'data:image/png;base64,' + pred.lime_explanation.lime_image_base64;
        limeImgElement.alt = 'LIME Explanation';
        limeContainer.appendChild(limeImgElement);
        card.appendChild(limeContainer);
      } else if (pred.lime_explanation && pred.lime_explanation.error) {
        const limeError = document.createElement('p');
        limeError.style.color = 'red';
        limeError.textContent = `LIME Error: ${pred.lime_explanation.error}`;
        card.appendChild(limeError);
      }
      resultsGrid.appendChild(card);
    });
  }
</script>
</body>
</html>
